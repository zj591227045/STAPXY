# æ•…éšœæ’é™¤æŒ‡å—

## ğŸ”§ å·²ä¿®å¤çš„é—®é¢˜

### 1. æœåŠ¡å™¨å¯åŠ¨æ—¶è®¿é—®æ§åˆ¶åŠ è½½é”™è¯¯

**é—®é¢˜ï¼š**
```
âš ï¸ æ— æ³•åŠ è½½è®¿é—®æ§åˆ¶é…ç½®: Cannot find module 'C:\Code\static-proxy\src\lib\config-loader.js'
```

**åŸå› ï¼š**
æœåŠ¡å™¨å°è¯•åŠ è½½å®¢æˆ·ç«¯è®¿é—®æ§åˆ¶é…ç½®ï¼Œä½†åœ¨æ–°æ¶æ„ä¸­è®¿é—®æ§åˆ¶å®Œå…¨ç”±å®¢æˆ·ç«¯ç®¡ç†ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- ç§»é™¤äº†æœåŠ¡å™¨ç«¯çš„è®¿é—®æ§åˆ¶é…ç½®åŠ è½½ä»£ç 
- æœåŠ¡å™¨ç°åœ¨ä¿æŒå®Œå…¨é™æ€ï¼Œä¸åŠ è½½ä»»ä½•è®¿é—®æ§åˆ¶é…ç½®

### 2. å®¢æˆ·ç«¯ WebSocket è¿æ¥æ–­å¼€é—®é¢˜

**é—®é¢˜ï¼š**
```
âœ… ç«™ç‚¹æ³¨å†ŒæˆåŠŸ: site1.localhost:3000 -> http://100.64.0.10:8080
ğŸ’“ å¯åŠ¨å¿ƒè·³ï¼Œé—´éš”: 30000ms
âŒ ä¸ä»£ç†æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€: code=1006, reason=
```

**å¯èƒ½åŸå› ï¼š**
1. å¿ƒè·³å¯åŠ¨æ—¶æœºè¿‡æ—©
2. å¿ƒè·³é—´éš”è¿‡çŸ­
3. WebSocket è¿æ¥ä¸ç¨³å®š

**è§£å†³æ–¹æ¡ˆï¼š**
1. **å»¶è¿Ÿå¿ƒè·³å¯åŠ¨**ï¼šæ³¨å†ŒæˆåŠŸåå»¶è¿Ÿ3ç§’å†å¯åŠ¨å¿ƒè·³
2. **å¢åŠ å¿ƒè·³é—´éš”**ï¼šä»30ç§’å¢åŠ åˆ°60ç§’
3. **æ”¹è¿›è¿æ¥æ£€æŸ¥**ï¼šåœ¨å‘é€å¿ƒè·³å‰æ£€æŸ¥è¿æ¥çŠ¶æ€
4. **æä¾›ç®€åŒ–ç‰ˆå®¢æˆ·ç«¯**ï¼šç”¨äºæµ‹è¯•åŸºæœ¬è¿æ¥ç¨³å®šæ€§

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•æœåŠ¡å™¨å¯åŠ¨

```bash
# å¯åŠ¨æœåŠ¡å™¨
npm run dev

# åº”è¯¥çœ‹åˆ°ï¼š
# ğŸš€ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼
# ğŸ“¡ Next.js åº”ç”¨: http://localhost:3000
# ğŸ”Œ WebSocket ç«¯ç‚¹: ws://localhost:3000/ws
# ğŸŒ ä»£ç†æœåŠ¡: http://*.localhost:3000
```

### 2. æµ‹è¯•åŸºæœ¬è¿æ¥ï¼ˆä½¿ç”¨ç®€åŒ–ç‰ˆå®¢æˆ·ç«¯ï¼‰

```bash
# è¿›å…¥å®¢æˆ·ç«¯ç›®å½•
cd client

# å¯åŠ¨ç®€åŒ–ç‰ˆå®¢æˆ·ç«¯
node examples/site1-simple.js

# åº”è¯¥çœ‹åˆ°ï¼š
# ğŸš€ å¯åŠ¨ç®€åŒ–ç‰ˆä»£ç†å®¢æˆ·ç«¯...
# æ­£åœ¨è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨...
# âœ… å·²è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨
# ğŸ‰ æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯: Connected to static proxy server
# ğŸ“ æ­£åœ¨æ³¨å†Œç«™ç‚¹: site1 (site1.localhost:3000)
# âœ… ç«™ç‚¹æ³¨å†ŒæˆåŠŸ: site1.localhost:3000 -> http://100.64.0.10:8080
# ğŸ’“ å¯åŠ¨å¿ƒè·³ï¼Œé—´éš”: 60000ms
```

### 3. æµ‹è¯•å®Œæ•´åŠŸèƒ½ï¼ˆå¸¦è®¿é—®æ§åˆ¶ï¼‰

```bash
# å¯åŠ¨å®Œæ•´ç‰ˆå®¢æˆ·ç«¯
node examples/site1.js

# åº”è¯¥çœ‹åˆ°è®¿é—®æ§åˆ¶åˆå§‹åŒ–ä¿¡æ¯ï¼š
# ğŸ›¡ï¸ è®¿é—®æ§åˆ¶ç³»ç»Ÿå·²åˆå§‹åŒ–
```

### 4. æµ‹è¯•ä»£ç†åŠŸèƒ½

```bash
# åœ¨æµè§ˆå™¨ä¸­è®¿é—®
http://site1.localhost:3000/

# åº”è¯¥æ­£ç¡®ä»£ç†åˆ°ç›®æ ‡æœåŠ¡å™¨
```

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æ£€æŸ¥ WebSocket è¿æ¥

```javascript
// åœ¨å®¢æˆ·ç«¯æ·»åŠ æ›´å¤šè°ƒè¯•ä¿¡æ¯
this.ws.on('open', () => {
  console.log('âœ… WebSocket è¿æ¥å·²å»ºç«‹');
  console.log('   readyState:', this.ws.readyState);
  console.log('   protocol:', this.ws.protocol);
});

this.ws.on('close', (code, reason) => {
  console.log('âŒ WebSocket è¿æ¥å…³é—­');
  console.log('   code:', code);
  console.log('   reason:', reason.toString());
  console.log('   wasClean:', code === 1000);
});
```

### 2. æ£€æŸ¥æœåŠ¡å™¨ç«¯è¿æ¥

åœ¨ `server.js` ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```javascript
wss.on('connection', (ws, request) => {
  console.log('ğŸ”— æ–°çš„ WebSocket è¿æ¥');
  console.log('   æ¥æº:', request.socket.remoteAddress);
  console.log('   User-Agent:', request.headers['user-agent']);
  
  ws.on('close', (code, reason) => {
    console.log(`ğŸ”Œ WebSocket è¿æ¥å…³é—­: code=${code}, reason=${reason.toString()}`);
    console.log('   æ˜¯å¦æ­£å¸¸å…³é—­:', code === 1000);
  });
});
```

### 3. æ£€æŸ¥å¿ƒè·³æœºåˆ¶

```javascript
// å®¢æˆ·ç«¯å¿ƒè·³è°ƒè¯•
startHeartbeat() {
  console.log(`ğŸ’“ å¯åŠ¨å¿ƒè·³ï¼Œé—´éš”: ${this.config.heartbeatInterval}ms`);
  this.heartbeatTimer = setInterval(() => {
    if (this.isConnected && this.ws && this.ws.readyState === WebSocket.OPEN) {
      console.log(`ğŸ’“ å‘é€å¿ƒè·³ (readyState: ${this.ws.readyState})`);
      // ... å‘é€å¿ƒè·³
    } else {
      console.log(`âš ï¸ è·³è¿‡å¿ƒè·³å‘é€ (connected: ${this.isConnected}, readyState: ${this.ws?.readyState})`);
    }
  }, this.config.heartbeatInterval);
}
```

## ğŸ“‹ å¸¸è§é—®é¢˜

### Q1: WebSocket è¿æ¥ç«‹å³æ–­å¼€

**æ£€æŸ¥é¡¹ï¼š**
1. ç«¯å£æ˜¯å¦è¢«å ç”¨
2. é˜²ç«å¢™è®¾ç½®
3. ä»£ç†æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
4. WebSocket è·¯å¾„æ˜¯å¦æ­£ç¡® (`/ws`)

### Q2: æ³¨å†ŒæˆåŠŸä½†å¿ƒè·³å¤±è´¥

**æ£€æŸ¥é¡¹ï¼š**
1. å¿ƒè·³é—´éš”è®¾ç½®
2. æœåŠ¡å™¨ç«¯å¿ƒè·³å¤„ç†é€»è¾‘
3. ç½‘ç»œè¿æ¥ç¨³å®šæ€§

### Q3: ä»£ç†è¯·æ±‚å¤±è´¥

**æ£€æŸ¥é¡¹ï¼š**
1. ç›®æ ‡æœåŠ¡å™¨æ˜¯å¦å¯è¾¾
2. ç›®æ ‡ URL é…ç½®æ˜¯å¦æ­£ç¡®
3. ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

## ğŸ› ï¸ é…ç½®å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```javascript
const config = {
  heartbeatInterval: 60000,    // 60ç§’å¿ƒè·³
  reconnectInterval: 5000,     // 5ç§’é‡è¿
  requestTimeout: 30000,       // 30ç§’è¯·æ±‚è¶…æ—¶
};
```

### å¼€å‘ç¯å¢ƒé…ç½®

```javascript
const config = {
  heartbeatInterval: 30000,    // 30ç§’å¿ƒè·³
  reconnectInterval: 2000,     // 2ç§’é‡è¿
  requestTimeout: 10000,       // 10ç§’è¯·æ±‚è¶…æ—¶
};
```

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æœåŠ¡å™¨æ—¥å¿—**ï¼šå®Œæ•´çš„æœåŠ¡å™¨å¯åŠ¨å’Œè¿è¡Œæ—¥å¿—
2. **å®¢æˆ·ç«¯æ—¥å¿—**ï¼šå®¢æˆ·ç«¯è¿æ¥å’Œé”™è¯¯æ—¥å¿—
3. **ç½‘ç»œç¯å¢ƒ**ï¼šæ“ä½œç³»ç»Ÿã€Node.js ç‰ˆæœ¬ã€ç½‘ç»œé…ç½®
4. **é”™è¯¯å¤ç°æ­¥éª¤**ï¼šè¯¦ç»†çš„æ“ä½œæ­¥éª¤

è¿™å°†å¸®åŠ©å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚
